<div class="p-4">
  <h1 class="text-2xl font-bold mb-4">üèãÔ∏è Your Workout Dashboard</h1>

  <!-- Stats -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <h2 class="card-title text-lg">Total Exercises Tracked</h2>
        <p class="text-2xl font-bold text-primary"><%= current_user.exercise_trackings.count %></p>
      </div>
    </div>
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <h2 class="card-title text-lg">Total Weight Lifted (kg)</h2>
        <p class="text-2xl font-bold text-secondary">
          <%= current_user.exercise_trackings.sum(:weight) %>
        </p>
      </div>
    </div>
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <h2 class="card-title text-lg">Recent Workout Plan</h2>
        <% if (recent = current_user.workout_plans.last) %>
          <p><%= link_to recent.name, workout_plan_exercises_path(recent), class: "link link-primary" %></p>
        <% else %>
          <p class="text-base-content/70">No plans yet.</p>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Real-Time Tracking Feed -->
  <div class="card bg-base-100 shadow-xl ">
    <div class="card-body">
      <h2 class="card-title text-xl mb-2">üü¢ Live Tracking Feed</h2>
      <div id="tracking_feed">
        <%= turbo_frame_tag "tracking_feed" do %>
          <%= render partial: "exercise_trackings/tracking", collection: current_user.exercise_trackings.order(created_at: :desc).limit(10), as: :tracking %>
        <% end %>
      </div>
    </div>
  </div>
</div>

<div class="max-w-3xl mx-auto p-6 flex flex-col md:flex-row gap-6">
  <div class="card bg-base-100 shadow-xl flex-1 items-baseline-last">
    <div class="card-body flex items-center">
      <h2 class="card-title text-xl text-center">Weekly Workout Overview</h2>
      <canvas id="myChart" data-controller="chart" class="w-full h-64"></canvas>
    </div>
  </div>
  <div class="card bg-base-100 shadow-xl flex-1">
    <div class="card-body">
      <h2 class="card-title text-xl text-center">Today's Calories: <%= @total_calories %></h2>
      <canvas id="macroChart" width="300" height="300" class="mx-auto"></canvas>
    </div>
  </div>
</div>


<script>
  document.addEventListener("turbo:load", () => {
    const protein = <%= @macros[:protein] || 0 %>;
    const carbs = <%= @macros[:carbs] || 0 %>;
    const fats = <%= @macros[:fats] || 0 %>;

    const ctx = document.getElementById("macroChart")?.getContext("2d");

    if (!ctx) return;

    // Destroy old chart if it exists
    if (window.macroChartInstance) {
      window.macroChartInstance.destroy();
    }

    // Create new chart
    window.macroChartInstance = new Chart(ctx, {
      type: "doughnut",
      data: {
        labels: ["Protein", "Carbs", "Fats"],
        datasets: [{
          label: "Macros (g)",
          data: [protein, carbs, fats],
          backgroundColor: ["#60a5fa", "#facc15", "#f87171"],
          borderColor: ["#3b82f6", "#eab308", "#ef4444"],
          borderWidth: 1
        }]
      },
      options: {
        responsive: false,
        plugins: {
          legend: {
            position: "bottom"
          }
        }
      }
    });
  });
</script>
