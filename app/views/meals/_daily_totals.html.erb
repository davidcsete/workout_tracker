<%= turbo_frame_tag "daily_totals" do %>
  <% total_macros = current_user.meals.joins(:food_items).select(
    "SUM(food_items.calories) AS total_calories",
    "SUM(food_items.protein) AS total_protein",
    "SUM(food_items.carbs) AS total_carbs",
    "SUM(food_items.fats) AS total_fats"
  ).where(consumed_at: date.all_day).take %>

  <% diet_goal = current_user.diet_goal %>

  <% if total_macros && total_macros.total_calories %>
    <div class="card bg-base-100 shadow-xl mb-8">
      <div class="card-body">
        <h2 class="card-title text-2xl mb-6 flex items-center gap-3">
          <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
          </svg>
          Today's Nutrition Summary
        </h2>
        
        <div class="grid grid-cols-4 gap-1 sm:gap-3 md:gap-6">
          <!-- Calories -->
          <div class="card bg-primary/5 border border-primary/20 shadow-sm min-w-0">
            <div class="card-body p-1 sm:p-3 text-center">
              <div class="text-xs font-semibold text-primary mb-1 truncate">Calories</div>
              <div class="text-sm sm:text-xl md:text-2xl font-bold text-primary mb-1 break-words">
                <%= total_macros.total_calories.to_i %>
              </div>
              <% if diet_goal %>
                <div class="text-xs text-primary/70 mb-1 sm:mb-3 hidden sm:block">
                  Goal: <%= diet_goal.daily_calories %> kcal
                </div>
                <progress class="progress progress-primary w-full h-1 sm:h-2" value="<%= [((total_macros.total_calories.to_f / diet_goal.daily_calories) * 100), 100].min %>" max="100"></progress>
                <div class="text-xs text-primary/60 mt-1 hidden sm:block">
                  <%= [((total_macros.total_calories.to_f / diet_goal.daily_calories) * 100), 100].min.round %>%
                </div>
              <% else %>
                <div class="text-xs text-primary/70 hidden sm:block">kcal</div>
              <% end %>
            </div>
          </div>

          <!-- Protein -->
          <div class="card bg-secondary/5 border border-secondary/20 shadow-sm min-w-0">
            <div class="card-body p-1 sm:p-3 text-center">
              <div class="text-xs font-semibold text-secondary mb-1 truncate">Protein</div>
              <div class="text-sm sm:text-xl md:text-2xl font-bold text-secondary mb-1 break-words">
                <%= total_macros.total_protein.to_f.round(1) %>g
              </div>
              <% if diet_goal %>
                <div class="text-xs text-secondary/70 mb-1 sm:mb-3 hidden sm:block">
                  Goal: <%= diet_goal.protein_grams %>g
                </div>
                <progress class="progress progress-secondary w-full h-1 sm:h-2" value="<%= [((total_macros.total_protein.to_f / diet_goal.protein_grams) * 100), 100].min %>" max="100"></progress>
                <div class="text-xs text-secondary/60 mt-1 hidden sm:block">
                  <%= [((total_macros.total_protein.to_f / diet_goal.protein_grams) * 100), 100].min.round %>%
                </div>
              <% else %>
                <div class="text-xs text-secondary/70 hidden sm:block">grams</div>
              <% end %>
            </div>
          </div>

          <!-- Carbs -->
          <div class="card bg-accent/5 border border-accent/20 shadow-sm min-w-0">
            <div class="card-body p-1 sm:p-3 text-center">
              <div class="text-xs font-semibold text-accent mb-1 truncate">Carbs</div>
              <div class="text-sm sm:text-xl md:text-2xl font-bold text-accent mb-1 break-words">
                <%= total_macros.total_carbs.to_f.round(1) %>g
              </div>
              <% if diet_goal %>
                <div class="text-xs text-accent/70 mb-1 sm:mb-3 hidden sm:block">
                  Goal: <%= diet_goal.carb_grams %>g
                </div>
                <progress class="progress progress-accent w-full h-1 sm:h-2" value="<%= [((total_macros.total_carbs.to_f / diet_goal.carb_grams) * 100), 100].min %>" max="100"></progress>
                <div class="text-xs text-accent/60 mt-1 hidden sm:block">
                  <%= [((total_macros.total_carbs.to_f / diet_goal.carb_grams) * 100), 100].min.round %>%
                </div>
              <% else %>
                <div class="text-xs text-accent/70 hidden sm:block">grams</div>
              <% end %>
            </div>
          </div>

          <!-- Fats -->
          <div class="card bg-warning/5 border border-warning/20 shadow-sm min-w-0">
            <div class="card-body p-1 sm:p-3 text-center">
              <div class="text-xs font-semibold text-warning mb-1 truncate">Fats</div>
              <div class="text-sm sm:text-xl md:text-2xl font-bold text-warning mb-1 break-words">
                <%= total_macros.total_fats.to_f.round(1) %>g
              </div>
              <% if diet_goal %>
                <div class="text-xs text-warning/70 mb-1 sm:mb-3 hidden sm:block">
                  Goal: <%= diet_goal.fat_grams %>g
                </div>
                <progress class="progress progress-warning w-full h-1 sm:h-2" value="<%= [((total_macros.total_fats.to_f / diet_goal.fat_grams) * 100), 100].min %>" max="100"></progress>
                <div class="text-xs text-warning/60 mt-1 hidden sm:block">
                  <%= [((total_macros.total_fats.to_f / diet_goal.fat_grams) * 100), 100].min.round %>%
                </div>
              <% else %>
                <div class="text-xs text-warning/70 hidden sm:block">grams</div>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% else %>
    <div class="alert alert-info mb-8">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <span>No nutrition data available for today. Start by adding your first meal!</span>
    </div>
  <% end %>
<% end %>